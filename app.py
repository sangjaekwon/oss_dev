import streamlit as st
import pandas as pd
import plotly.express as px
import folium
from streamlit_folium import folium_static
import chardet

# ---- 데이터 로딩 ----
@st.cache_data
def load_data():
    # 인코딩 자동 감지
    with open("accident_stats.csv", "rb") as f:
        result = chardet.detect(f.read())
        encoding = result["encoding"]
    
    df = pd.read_csv("accident_stats.csv", encoding=encoding)
    
    # 컬럼명 전처리 (여기서는 공백 제거)
    df.columns = df.columns.str.strip()
    return df

df = load_data()

# ---- 사이드바 필터 ----
st.sidebar.header("🧪 필터 설정")
selected_sido = st.sidebar.multiselect("시도", df["시도"].unique())

# ---- 필터 적용 ----
filtered = df[df["시도"].isin(selected_sido)]  # 선택한 시도에 맞는 데이터 필터링

st.title("🚧 시도/시군구별 교통사고 통계 분석")
st.write(f"▶️ 선택된 시도: {', '.join(selected_sido)}")

# ---- 데이터 표 ----
st.subheader("📋 사고 통계 테이블")
st.dataframe(filtered)

# ---- 시군구별 사고 발생 건수 ----
st.subheader("📊 시군구별 사고 발생건수")
bar = px.bar(filtered, x="시군구", y="사고건수", color="시도", title="시군구별 사고 발생건수")
st.plotly_chart(bar)

# ---- 시군구별 부상자 유형 비교 ----
st.subheader("🤕 부상자 유형 비교")
injury_df = filtered[["시군구", "중상자수", "경상자수", "부상신고자수"]].melt(
    id_vars="시군구", var_name="부상자유형", value_name="인원수"
)
injury_chart = px.bar(injury_df, x="시군구", y="인원수", color="부상자유형", barmode="group", title="시군구별 부상자 유형 비교")
st.plotly_chart(injury_chart)

# ---- 지도 시각화 ----
st.subheader("🗺️ 사고 건수 지도 시각화 (대한민국 전체)")

# 대한민국 시군구 좌표 (시도별 대략적인 좌표 예시)
# 대한민국 시군구 좌표 (시도별 대략적인 좌표 예시)
location_data = {
    # 서울
    '종로구': [37.5729503, 126.9793579],
    '중구': [37.5638439, 126.997602],
    '용산구': [37.5324275, 126.990146],
    '성동구': [37.550978, 127.040580],
    '광진구': [37.538484, 127.082293],
    '동대문구': [37.574368, 127.039569],
    '중랑구': [37.606991, 127.092789],
    '성북구': [37.589400, 127.016637],
    '강북구': [37.646995, 127.014573],
    '은평구': [37.6027, 126.9330],
    '서대문구': [37.5775, 126.9369],
    '마포구': [37.5660, 126.9052],
    '강서구': [37.5507, 126.8494],
    '구로구': [37.4951, 126.8848],
    '영등포구': [37.5266, 126.9007],
    '동작구': [37.5115, 126.9399],
    '관악구': [37.4785, 126.9518],
    '강남구': [37.5172, 127.0473],
    '강동구': [37.5300, 127.1207],
    '송파구': [37.5143, 127.1056],
    '서초구': [37.4830, 127.0324],
    '양천구': [37.5135, 126.8748],
    '중랑구': [37.606991, 127.092789],
    '노원구': [37.6565, 127.0777],
    '광진구': [37.538484, 127.082293],
    '강북구': [37.646995, 127.014573],
    '금천구': [37.4523, 126.9004],
    
    # 부산
    '중구': [35.1796, 129.0756],
    '서구': [35.0703, 129.0247],
    '동구': [35.1031, 129.0326],
    '영도구': [35.0916, 129.0729],
    '부산진구': [35.1607, 129.0578],
    '동래구': [35.2321, 129.0717],
    '남구': [35.1283, 129.0703],
    '북구': [35.1794, 129.0149],
    '해운대구': [35.1621, 129.1636],
    '사하구': [35.0893, 128.9995],
    '금정구': [35.2367, 129.0985],
    '강서구': [35.1595, 129.1699],
    '연제구': [35.1697, 129.0601],
    '수영구': [35.1647, 129.1161],
    '사상구': [35.1467, 128.9967],
    '기장군': [35.2358, 129.2257],
    
    # 경기
    '수원시': [37.2636, 127.0286],
    '성남시': [37.4384, 127.1371],
    '의정부시': [37.7395, 127.0372],
    '안양시': [37.3945, 126.9393],
    '부천시': [37.4830, 126.7735],
    '안산시': [37.3210, 126.8319],
    '평택시': [37.0020, 127.1236],
    '광명시': [37.4786, 126.8736],
    '구리시': [37.5942, 127.1275],
    '양주시': [37.7596, 127.0335],
    '여주시': [37.2953, 127.6351],
    '화성시': [37.2041, 127.8355],
    '시흥시': [37.4520, 126.7736],
    '파주시': [37.7595, 126.7708],
    '고양시': [37.6584, 126.8320],
    '광주시': [37.3214, 127.2514],
    '연천군': [38.0710, 127.1762],
    '포천시': [37.8977, 127.2004],
    '가평군': [37.8321, 127.5156],
    '양평군': [37.4975, 127.4736],
    '이천시': [37.2744, 127.4883],
    '용인시': [37.2412, 127.1780],
    '안성시': [37.0105, 127.2722],
    '김포시': [37.6305, 126.7318],
    '동두천시': [37.9030, 127.1382],
    '과천시': [37.4234, 126.9984],
    '군포시': [37.3582, 126.9274],
    '남양주시': [37.6357, 127.1777],
    '오산시': [37.1500, 127.0669],
    '의왕시': [37.3380, 126.9866],
    '하남시': [37.5285, 127.2206],
    
    # 강원
    '춘천시': [37.8756, 127.7308],
    '원주시': [37.3475, 127.9536],
    '동해시': [37.5200, 129.1141],
    '강릉시': [37.7510, 128.8769],
    '속초시': [38.2084, 128.5919],
    '태백시': [37.5082, 128.9876],
    '삼척시': [38.4386, 128.1972],
    '홍천군': [37.7113, 127.8954],
    '횡성군': [37.4410, 128.2124],
    '영월군': [37.1890, 128.2184],
    '평창군': [37.4144, 128.3907],
    '정선군': [37.4355, 128.1905],
    '철원군': [38.2039, 127.3030],
    '화천군': [38.0856, 127.7342],
    '양구군': [38.1155, 127.9393],
    '인제군': [38.1455, 128.1826],
    '고성군': [38.3159, 128.4143],
    '양양군': [38.0866, 128.5384],
    
    # 충북
    '청주시': [36.6352, 127.4912],
    '충주시': [36.9875, 127.9319],
    '제천시': [37.1392, 128.1894],
    '보은군': [36.4482, 127.7249],
    '옥천군': [36.3312, 127.6169],
    '영동군': [36.1490, 127.6880],
    '진천군': [36.8040, 127.4627],
    '괴산군': [36.6760, 127.7881],
    '음성군': [36.7663, 127.5622],
    '단양군': [36.9971, 127.5200],
    '증평군': [36.7016, 127.6211],
    
    # 충남
    '천안시': [36.3504, 127.3845],
    '아산시': [36.7757, 127.0271],
    '보령시': [36.3697, 126.5893],
    '공주시': [36.4679, 127.1217],
    '서산시': [36.7762, 126.4513],
    '금산군': [36.1149, 127.5614],
    '태안군': [36.7190, 126.2613],
    '홍성군': [36.6651, 126.6954],
    '예산군': [36.6753, 126.7571],
    '청양군': [36.4690, 126.7470],
    '부여군': [36.2869, 126.9330],
    '서천군': [36.0299, 126.5373],
    # 전북
    '전주시': [35.8240, 127.1500],
    '익산시': [35.9504, 126.9779],
    '군산시': [35.9740, 126.7375],
    '정읍시': [35.5631, 126.8444],
    '남원시': [35.3767, 127.4049],
    '김제시': [35.8147, 126.8541],
    '완주군': [35.9025, 127.2041],
    '진안군': [35.6430, 127.3657],
    '무주군': [35.7715, 127.7371],
    '장수군': [35.5225, 127.2673],
    '임실군': [35.5819, 127.2079],
    '순창군': [35.4524, 127.2305],
    '고창군': [35.4413, 126.7014],
    '부안군': [35.7209, 126.7282],
    
    # 전남
    '목포시': [34.8106, 126.3922],
    '여수시': [34.7605, 127.6628],
    '순천시': [34.9506, 127.4874],
    '광양시': [34.9507, 127.6701],
    '담양군': [35.3253, 127.1521],
    '곡성군': [35.3064, 127.2900],
    '구례군': [35.2321, 127.4486],
    '고흥군': [34.5906, 127.2039],
    '보성군': [34.7559, 127.1134],
    '화순군': [35.0322, 126.9709],
    '장흥군': [34.6330, 126.8840],
    '강진군': [34.6104, 126.7342],
    '해남군': [34.5662, 126.5917],
    '영암군': [34.6572, 126.7232],
    '무안군': [34.9759, 126.3929],
    '함평군': [34.8830, 126.5280],
    '영광군': [35.2811, 126.5181],
    '완도군': [34.3049, 126.7420],
    '진도군': [34.4840, 126.2217],
    '신안군': [34.7001, 126.0814],
}

map_center = [36.5, 127.5]  # 대한민국의 대략적인 중심
m = folium.Map(location=map_center, zoom_start=7)

# 사고 건수에 따른 마커 추가
for _, row in filtered.iterrows():
    sigungu = row["시군구"]
    count = row["사고건수"]
    if sigungu in location_data:
        lat, lon = location_data[sigungu]
        folium.CircleMarker(
            location=[lat, lon],
            radius=min(count / 5, 20),  # 사고 건수가 클수록 큰 마커
            popup=f"{sigungu}: {count}건",
            color='crimson',
            fill=True,
            fill_color='crimson'
        ).add_to(m)

folium_static(m)
